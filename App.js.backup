// App.js
// Punto de entrada: configura Navigation con Bottom Tabs, expo-notifications y permisos b√°sicos.
// Navegaci√≥n principal por pesta√±as + Stack para modales (TaskDetail, TaskChat)

// IMPORTANTE: Este import debe estar PRIMERO antes de cualquier otro
import 'react-native-gesture-handler';

import React, { useEffect, useState, useRef } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { GestureHandlerRootView } from 'react-native-gesture-handler';
import { View, Text, TouchableOpacity, StyleSheet, ActivityIndicator } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import Toast from 'react-native-toast-message';

// Importaciones lazy para evitar problemas de carga
let HomeScreen, LoginScreen, TaskDetailScreen, TaskChatScreen, MyInboxScreen, KanbanScreen, ReportScreen, AdminScreen, CalendarScreen;

try {
  HomeScreen = require('./screens/HomeScreen').default;
  LoginScreen = require('./screens/LoginScreen').default;
  TaskDetailScreen = require('./screens/TaskDetailScreen').default;
  TaskChatScreen = require('./screens/TaskChatScreen').default;
  MyInboxScreen = require('./screens/MyInboxScreen').default;
  KanbanScreen = require('./screens/KanbanScreen').default;
  ReportScreen = require('./screens/ReportScreen').default;
  AdminScreen = require('./screens/AdminScreen').default;
  CalendarScreen = require('./screens/CalendarScreen').default;
} catch (error) {
  console.error('‚ùå Error al cargar screens:', error);
}

import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import { getCurrentSession } from './services/authFirestore';

// Configurar handler de notificaciones
try {
  Notifications.setNotificationHandler({
    handleNotification: async () => ({
      shouldShowAlert: true,
      shouldPlaySound: true,
      shouldSetBadge: true,
    }),
  });
} catch (error) {
  console.log('‚ö†Ô∏è Notificaciones no disponibles:', error.message);
}

const Stack = createNativeStackNavigator();

// Componente de navegaci√≥n por tabs personalizado

function CustomTabBar({ activeTab, setActiveTab, userRole, userName, onLogout }) {
  const allTabs = [
    { name: 'Tareas', icon: 'checkbox-outline', screen: 'Home' },
    { name: 'Calendario', icon: 'calendar-outline', screen: 'Calendar' },
    { name: 'Kanban', icon: 'grid-outline', screen: 'Kanban' },
    { name: 'Reportes', icon: 'stats-chart-outline', screen: 'Report' },
    { name: 'Admin', icon: 'settings-outline', screen: 'Admin' }
  ];

  // Filtrar tabs seg√∫n rol:
  // - Operativo: Solo Tareas, Calendario y Kanban
  // - Jefe/Admin: Todos los tabs (Admin solo para admin)
  let tabs = allTabs;
  if (userRole === 'operativo') {
    tabs = allTabs.filter(tab => ['Home', 'Calendar', 'Kanban'].includes(tab.screen));
  } else if (userRole !== 'admin') {
    tabs = allTabs.filter(tab => tab.screen !== 'Admin');
  }

  return (
    <View>
      {/* Indicador de rol */}
      {userRole && (
        <View style={styles.roleIndicator}>
          <View style={{ flexDirection: 'row', alignItems: 'center' }}>
            <View style={[styles.roleBadge, userRole === 'admin' && styles.roleBadgeAdmin]}>
              <Ionicons 
                name={userRole === 'admin' ? 'shield-checkmark' : 'person'} 
                size={14} 
                color="#FFFFFF" 
                style={{ marginRight: 4 }}
              />
              <Text style={styles.roleBadgeText}>
                {userRole === 'admin' ? 'Admin' : userRole === 'jefe' ? 'Jefe' : 'Operativo'}
              </Text>
            </View>
            {userName && (
              <Text style={styles.userNameText}>{userName}</Text>
            )}
          </View>
          <TouchableOpacity
            onPress={onLogout}
            style={styles.logoutButton}
          >
            <Ionicons name="log-out-outline" size={20} color="#8B0000" />
            <Text style={styles.logoutText}>Salir</Text>
          </TouchableOpacity>
        </View>
      )}
      <View style={styles.tabBar}>
      {tabs.map((tab) => (
        <TouchableOpacity
          key={tab.screen}
          style={styles.tabItem}
          onPress={() => setActiveTab(tab.screen)}
        >
          <Ionicons 
            name={activeTab === tab.screen ? tab.icon.replace('-outline', '') : tab.icon} 
            size={activeTab === tab.screen ? 28 : 24} 
            color={activeTab === tab.screen ? '#8B0000' : '#8E8E93'} 
            style={styles.tabIcon}
          />
          <Text style={[
            styles.tabLabel,
            activeTab === tab.screen && styles.tabLabelActive
          ]}>
            {tab.name}
          </Text>
        </TouchableOpacity>
      ))}
      </View>
    </View>
  );
}

// Navegador principal
function MainNavigator({ navigation, onLogout }) {
  const [activeTab, setActiveTab] = useState('Home');
  const [userRole, setUserRole] = useState(null);
  const [userName, setUserName] = useState(null);

  useEffect(() => {
    loadUserRole();
  }, []);

  const loadUserRole = async () => {
    const result = await getCurrentSession();
    if (result.success) {
      setUserRole(result.session.role);
      setUserName(result.session.displayName);
    }
  };

  const renderScreen = () => {
    const screenProps = { navigation, onLogout };
    
    switch (activeTab) {
      case 'Home':
        return <HomeScreen {...screenProps} />;
      case 'Calendar':
        return <CalendarScreen {...screenProps} />;
      case 'Kanban':
        return <KanbanScreen {...screenProps} />;
      case 'MyInbox':
        return <MyInboxScreen {...screenProps} />;
      case 'Report':
        return <ReportScreen {...screenProps} />;
      case 'Admin':
        return <AdminScreen {...screenProps} />;
      default:
        return <HomeScreen {...screenProps} />;
    }
  };

  return (
    <View style={{ flex: 1 }}>
      {renderScreen()}
      <CustomTabBar 
        activeTab={activeTab} 
        setActiveTab={setActiveTab} 
        userRole={userRole} 
        userName={userName} 
        onLogout={onLogout}
      />
    </View>
  );
}

export default function App() {
  console.log('üöÄ App iniciando...');
  const navigationRef = useRef();
  const [isLoading, setIsLoading] = useState(true);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  
  useEffect(() => {
    let mounted = true;
    let timeoutId;
    
    const checkSession = async () => {
      try {
        console.log('üîç Verificando sesi√≥n...');
        
        // Timeout de 3 segundos
        timeoutId = setTimeout(() => {
          if (mounted) {
            console.log('‚è±Ô∏è Timeout alcanzado, mostrando login');
            setIsLoading(false);
            setIsAuthenticated(false);
          }
        }, 3000);
        
        const result = await getCurrentSession();
        clearTimeout(timeoutId);
        
        console.log('üìã Resultado:', result);
        if (mounted) {
          setIsAuthenticated(result.success);
          setIsLoading(false);
        }
      } catch (error) {
        console.error('‚ùå Error al verificar sesi√≥n:', error);
        clearTimeout(timeoutId);
        if (mounted) {
          setIsAuthenticated(false);
          setIsLoading(false);
        }
      }
    };

    checkSession();
    
    return () => {
      mounted = false;
      if (timeoutId) clearTimeout(timeoutId);
    };
  }, []);

  const handleLogout = async () => {
    const { logoutUser } = require('./services/authFirestore');
    await logoutUser();
    setIsAuthenticated(false);
  };
  
  useEffect(() => {
    (async () => {
      // Pedir permiso para notificaciones (solo funciona en development build, no en Expo Go)
      if (Device.isDevice) {
        try {
          const { status: existingStatus } = await Notifications.getPermissionsAsync();
          let finalStatus = existingStatus;
          if (existingStatus !== 'granted') {
            const { status } = await Notifications.requestPermissionsAsync();
            finalStatus = status;
          }
          if (finalStatus !== 'granted') {
            console.log('[Notifications] Permisos de notificaci√≥n denegados');
          } else {
            console.log('[Notifications] Permisos de notificaci√≥n concedidos');
          }
        } catch (error) {
          // Silenciar error en Expo Go donde push notifications no est√°n disponibles
          console.log('[Notifications] No disponibles en Expo Go');
        }
      }
    })();

    // Listener para notificaciones recibidas cuando la app est√° en foreground
    const notificationListener = Notifications.addNotificationReceivedListener(notification => {
      console.log('[Notifications] Recibida:', notification.request.content.title);
    });

    // Listener para cuando el usuario interact√∫a con una notificaci√≥n
    const responseListener = Notifications.addNotificationResponseReceivedListener(response => {
      const data = response.notification.request.content.data;
      console.log('[Notifications] Usuario interactu√≥:', data);
      
      // Navegar a la tarea si se proporciona el ID
      if (data.taskId && navigationRef.current) {
        navigationRef.current.navigate('TaskDetail', { taskId: data.taskId });
      }
    });

    return () => {
      notificationListener.remove();
      responseListener.remove();
    };
  }, []);

  if (isLoading) {
    console.log('üîÑ Mostrando pantalla de carga');
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#8B0000" />
        <Text style={styles.loadingText}>Cargando...</Text>
      </View>
    );
  }

  console.log('‚úÖ Renderizando app principal', { isAuthenticated });

  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <NavigationContainer 
        ref={navigationRef}
        onReady={() => console.log('üì± NavigationContainer ready')}
        onStateChange={(state) => console.log('üîÑ Navigation state:', state?.routes?.[state?.index]?.name)}
      >
          <Stack.Navigator
            screenOptions={{
              headerShown: false,
              animation: 'default',
              presentation: 'card',
              contentStyle: { backgroundColor: '#FAFAFA' },
            }}
          >
            {!isAuthenticated ? (
              <Stack.Screen 
                name="Login" 
                options={{ 
                  headerShown: false,
                  animation: 'fade',
                  gestureEnabled: false
                }}
              >
                {(props) => {
                  console.log('üîê Renderizando LoginScreen');
                  return <LoginScreen {...props} onLogin={() => {
                    console.log('‚úÖ onLogin called');
                    setIsAuthenticated(true);
                  }} />;
                }}
              </Stack.Screen>
            ) : (
              <>
                <Stack.Screen 
                  name="Main"
                  options={{ 
                    headerShown: false,
                    animation: 'fade',
                  }}
                >
                  {(props) => {
                    console.log('üè† Renderizando MainNavigator');
                    return <MainNavigator {...props} onLogout={handleLogout} />;
                  }}
                </Stack.Screen>
                <Stack.Screen 
                  name="TaskDetail" 
                  component={TaskDetailScreen}
                  options={{ 
                    presentation: 'card',
                    animation: 'slide_from_right',
                    gestureEnabled: true,
                  }}
                />
                <Stack.Screen 
                  name="TaskChat" 
                  component={TaskChatScreen}
                  options={{ 
                    presentation: 'modal',
                    animation: 'slide_from_bottom',
                    gestureEnabled: true,
                  }}
                />
            </>
          )}
        </Stack.Navigator>
      </NavigationContainer>
      <Toast />
    </GestureHandlerRootView>
  );
}

const styles = StyleSheet.create({
  roleIndicator: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 8,
    backgroundColor: 'rgba(255, 255, 255, 0.98)',
    borderTopWidth: 0.5,
    borderTopColor: 'rgba(0, 0, 0, 0.1)'
  },
  roleBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#5856D6',
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 12
  },
  roleBadgeAdmin: {
    backgroundColor: '#8B0000'
  },
  roleBadgeText: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: '700',
    letterSpacing: 0.3
  },
  userNameText: {
    fontSize: 13,
    color: '#6E6E73',
    fontWeight: '600',
    marginLeft: 8
  },
  logoutButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#FFE5E5',
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 12,
    gap: 4
  },
  logoutText: {
    fontSize: 12,
    color: '#8B0000',
    fontWeight: '700',
    letterSpacing: 0.3
  },
  tabBar: {
    flexDirection: 'row',
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    backdropFilter: 'blur(20px)',
    borderTopWidth: 0.5,
    borderTopColor: 'rgba(0, 0, 0, 0.1)',
    height: 85,
    paddingBottom: 20,
    paddingTop: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: -4 },
    shadowOpacity: 0.15,
    shadowRadius: 16,
    elevation: 12
  },
  tabItem: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 4
  },
  tabIcon: {
    marginBottom: 3
  },
  tabLabel: {
    fontSize: 10,
    color: '#8E8E93',
    fontWeight: '600',
    letterSpacing: 0.2
  },
  tabLabelActive: {
    color: '#8B0000',
    fontWeight: '700'
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#F8F9FA'
  },
  loadingText: {
    marginTop: 16,
    fontSize: 16,
    color: '#8B0000',
    fontWeight: '600'
  }
});
